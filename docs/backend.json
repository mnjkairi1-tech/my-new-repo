{
  "entities": {
    "SupportRequest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SupportRequest",
      "type": "object",
      "description": "Represents a user's request for support or general inquiry within the AI Atlas application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SupportRequest entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the unique identifier of the user who submitted the support request. (Relationship: User 1:N SupportRequest)"
        },
        "userName": {
          "type": "string",
          "description": "The name of the user who submitted the support request, for display and identification in an administrative view."
        },
        "subject": {
          "type": "string",
          "description": "A brief subject or title that summarizes the nature of the support request."
        },
        "message": {
          "type": "string",
          "description": "The detailed message from the user describing their problem, question, or inquiry."
        },
        "status": {
          "type": "string",
          "description": "The current processing status of the support request (e.g., 'new', 'open', 'in progress', 'resolved', 'closed')."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the support request was originally created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating the last time the support request was modified or updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "userName",
        "subject",
        "message",
        "status",
        "createdAt"
      ]
    },
    "BugReport": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "BugReport",
      "type": "object",
      "description": "Represents a user's report of a bug or technical issue encountered within the AI Atlas application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the BugReport entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the unique identifier of the user who submitted the bug report. (Relationship: User 1:N BugReport)"
        },
        "userName": {
          "type": "string",
          "description": "The name of the user who submitted the bug report, for display and identification in an administrative view."
        },
        "title": {
          "type": "string",
          "description": "A brief, concise title or summary of the reported bug."
        },
        "description": {
          "type": "string",
          "description": "A detailed explanation of the bug, including unexpected behavior and observed symptoms."
        },
        "reproductionSteps": {
          "type": "string",
          "description": "Clear and sequential steps that can be followed to reproduce the reported bug."
        },
        "environmentInfo": {
          "type": "string",
          "description": "Information about the user's operating environment when the bug occurred (e.g., browser type and version, operating system, device)."
        },
        "status": {
          "type": "string",
          "description": "The current processing status of the bug report (e.g., 'new', 'triaged', 'in progress', 'resolved', 'closed', 'wont-fix')."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the bug report was originally submitted.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating the last time the bug report was modified or updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "userName",
        "title",
        "description",
        "reproductionSteps",
        "status",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/supportRequests/{supportRequestId}",
        "definition": {
          "entityName": "SupportRequest",
          "schema": {
            "$ref": "#/backend/entities/SupportRequest"
          },
          "description": "A top-level collection for all user-submitted support requests. Each document includes denormalized 'userId' and 'userName' for authorization independence and efficient querying. Regular users can only access their own requests, while support staff can access all. QAPs are supported for both user-specific and admin-wide listings.",
          "params": [
            {
              "name": "supportRequestId",
              "description": "The unique identifier for a specific support request."
            }
          ]
        }
      },
      {
        "path": "/bugReports/{bugReportId}",
        "definition": {
          "entityName": "BugReport",
          "schema": {
            "$ref": "#/backend/entities/BugReport"
          },
          "description": "A top-level collection for all user-submitted bug reports. Each document includes denormalized 'userId' and 'userName' for authorization independence and efficient querying. Regular users can only access their own reports, while support staff can access all. QAPs are supported for both user-specific and admin-wide listings.",
          "params": [
            {
              "name": "bugReportId",
              "description": "The unique identifier for a specific bug report."
            }
          ]
        }
      },
      {
        "path": "/supportStaff/{userId}",
        "definition": {
          "entityName": "SupportStaffUser",
          "schema": {
            "$ref": "#/backend/entities/SupportStaffUser"
          },
          "description": "A collection containing documents where the document ID is the UID of a user designated as support staff. The mere existence of a document in this collection grants administrative read/write access to support requests and bug reports. This implements a Database-Backed Access Control (DBAC) model for roles.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier (UID) of the user who is a support staff member."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide clear separation of concerns, robust security, and efficient querying for both regular users and administrative staff, following the core design principles. \n\n**Authorization Independence:**\n1.  **Support Requests and Bug Reports:** Each `SupportRequest` and `BugReport` document includes `userId` and `userName`. This denormalization means that security rules do not need to perform `get()` operations on a separate `users` collection to verify ownership or display user information in an admin view. An authenticated user (`request.auth.uid`) can directly check if their UID matches `resource.data.userId` for ownership-based access. This enables atomic creation and updates.\n2.  **Admin Roles:** Support staff authorization is managed via a dedicated top-level collection, `/supportStaff/{userId}`. The existence of a document at this path signifies that the `userId` associated with the path is a support administrator. Security rules can atomically check `exists(/databases/$(database)/documents/supportStaff/$(request.auth.uid))` without relying on hierarchical dependencies or complex lookups within the data being accessed. This keeps security rules simple and performant.\n\n**QAPs (Query as a Principal):**\n1.  **User Access:** Regular users can securely list their own `SupportRequest` and `BugReport` documents by performing a query like `firestore.collection('supportRequests').where('userId', '==', currentUser.uid)`. This query is efficient, relies on `userId` within the document (Authorization Independence), and ensures users only retrieve data they are authorized to see. Similarly for bug reports.\n2.  **Admin Access:** Support staff can efficiently list *all* `SupportRequest` and `BugReport` documents from their respective top-level collections (`/supportRequests` and `/bugReports`). The security rules will grant `read` access to the entire collection if `request.auth.uid` is present in the `/supportStaff` collection. This allows a clear, unfiltered view for administrative purposes without violating security, as the authorization check is performed at the collection level based on the staff role.\n\n**Structural Segregation:**\n*   `supportRequests` and `bugReports` are distinct top-level collections. This ensures that all documents within each collection share the same security posture (user-owned, support-staff accessible). There is no mixing of public/private or different access levels within the same collection, simplifying rule writing.\n*   `supportStaff` is a separate collection specifically for managing roles, further segregating concerns.\n\n**Access Modeling:**\n*   **Private Data (User-Owned):** `SupportRequest` and `BugReport` documents are inherently user-owned, with `userId` clearly defining ownership within the document itself.\n*   **Global Roles (DBAC):** The `/supportStaff/{userId}` collection implements DBAC, where the role is determined by document existence in the database, not custom claims.\n\n**Data Clarity and Predictability:**\n*   Entities use explicit `status` fields (e.g., 'new', 'open') for clear state modeling.\n*   Consistent naming conventions are used: `userId`, `supportRequestId`, `bugReportId`, `createdAt`, `updatedAt`."
  }
}