rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * AI Atlas Security Rules
     *
     * Core Philosophy:
     * This ruleset implements a strict user-ownership model combined with a Database-Backed Access Control (DBAC) 
     * system for administrative staff. Users have full control over the support requests and bug reports they 
     * create, while designated support staff have global read and write access to manage these issues.
     *
     * Data Structure:
     * - /supportRequests/{id}: User-submitted support tickets.
     * - /bugReports/{id}: User-submitted technical issues.
     * - /supportStaff/{userId}: A role-based collection where the existence of a document grants admin privileges.
     *
     * Key Security Decisions:
     * - Authorization Independence: Every request/report contains a denormalized 'userId'. This allows rules 
     *   to verify ownership instantly without fetching additional user profile documents.
     * - DBAC for Roles: Administrative access is determined by the existence of a UID in the /supportStaff 
     *   collection. This avoids hardcoding UIDs or relying on complex custom claims during the prototype phase.
     * - Relational Integrity: The rules strictly enforce that the 'userId' field in any document matches 
     *   the UID of the authenticated creator, and that this field remains immutable after creation.
     */

    // --- Helper Functions ---

    /** Checks if the request is from an authenticated user. */
    function isSignedIn() {
      return request.auth != null;
    }

    /** Checks if the authenticated user's UID matches the provided userId. */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /** Checks if the document exists and the authenticated user is the owner. */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    /** 
     * Checks if the user is a member of the support staff.
     * This uses the DBAC pattern by checking for document existence in the /supportStaff collection.
     */
    function isSupportStaff() {
      return isSignedIn() && exists(/databases/$(database)/documents/supportStaff/$(request.auth.uid));
    }

    // --- Collection Rules ---

    /**
     * @description Rules for the supportStaff collection. Primarily used for role lookup.
     * @path /supportStaff/{userId}
     * @allow get: if signed in (to verify own or others' staff status).
     * @deny list, create, update, delete: if not a system administrator (restricted in prototype).
     * @principle Role-based access control via document existence.
     */
    match /supportStaff/{userId} {
      allow get: if isSignedIn();
      allow list: if isSupportStaff();
      allow create, update, delete: if false; // Managed via Firebase Console or Admin SDK in prototyping.
    }

    /**
     * @description Rules for user-submitted support requests.
     * @path /supportRequests/{supportRequestId}
     * @allow create: if user is authenticated and sets themselves as the owner.
     * @allow update, delete: if the user owns the document or is support staff.
     * @allow read: if the user owns the document or is support staff.
     * @principle Ownership-based access with administrative override and field immutability.
     */
    match /supportRequests/{supportRequestId} {
      allow get, list: if isSignedIn() && (isSupportStaff() || resource.data.userId == request.auth.uid);
      
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      allow update: if (isExistingOwner(resource.data.userId) || isSupportStaff()) && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isExistingOwner(resource.data.userId) || isSupportStaff();
    }

    /**
     * @description Rules for user-submitted bug reports.
     * @path /bugReports/{bugReportId}
     * @allow create: if user is authenticated and sets themselves as the owner.
     * @allow update, delete: if the user owns the document or is support staff.
     * @allow read: if the user owns the document or is support staff.
     * @principle Ownership-based access with administrative override and field immutability.
     */
    match /bugReports/{bugReportId} {
      allow get, list: if isSignedIn() && (isSupportStaff() || resource.data.userId == request.auth.uid);
      
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      allow update: if (isExistingOwner(resource.data.userId) || isSupportStaff()) && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isExistingOwner(resource.data.userId) || isSupportStaff();
    }
  }
}