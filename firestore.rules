rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * AI Atlas Security Rules
     *
     * Core Philosophy:
     * This ruleset implements a strict user-ownership model combined with a Database-Backed Access Control (DBAC) 
     * system for administrative staff. Users have full control over the support requests and bug reports they 
     * create, while designated support staff have global read and write access to manage these issues.
     *
     * Key Security Decisions:
     * - Owner Access: The user with email 'mnjkairi1@gmail.com' is treated as a global admin.
     * - DBAC for Roles: Administrative access is also determined by the existence of a UID in the /supportStaff collection.
     */

    // --- Helper Functions ---

    /** Checks if the request is from an authenticated user. */
    function isSignedIn() {
      return request.auth != null;
    }

    /** Checks if the authenticated user's UID matches the provided userId. */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /** Checks if the document exists and the authenticated user is the owner. */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    /** 
     * Checks if the user is a member of the support staff or the main owner.
     */
    function isSupportStaff() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/supportStaff/$(request.auth.uid)) ||
        request.auth.token.email == 'mnjkairi1@gmail.com'
      );
    }

    // --- Collection Rules ---

    /**
     * Rules for the supportStaff collection.
     */
    match /supportStaff/{userId} {
      allow get: if isSignedIn();
      allow list: if isSupportStaff();
      allow create, update, delete: if request.auth.token.email == 'mnjkairi1@gmail.com';
    }

    /**
     * Rules for user-submitted support requests.
     */
    match /supportRequests/{supportRequestId} {
      allow get, list: if isSignedIn() && (isSupportStaff() || resource.data.userId == request.auth.uid);
      
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      allow update: if (isExistingOwner(resource.data.userId) || isSupportStaff()) && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isExistingOwner(resource.data.userId) || isSupportStaff();
    }

    /**
     * Rules for user-submitted bug reports.
     */
    match /bugReports/{bugReportId} {
      allow get, list: if isSignedIn() && (isSupportStaff() || resource.data.userId == request.auth.uid);
      
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      allow update: if (isExistingOwner(resource.data.userId) || isSupportStaff()) && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isExistingOwner(resource.data.userId) || isSupportStaff();
    }
    
    /**
     * User profiles and group memberships.
     */
    match /user_profiles/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId);
    }
    
    match /users/{userId}/groupMemberships/{groupId} {
      allow read, write: if isOwner(userId);
    }
    
    match /groups/{groupId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isSupportStaff());
      
      match /members/{memberId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
      
      match /messages/{messageId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isSupportStaff());
      }
      
      match /tools/{toolId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
    }
  }
}